From a24874a2bb2ef25ce3c7827a0f330eaaa10b827c Mon Sep 17 00:00:00 2001
From: "eric.park" <eric.park@intel.com>
Date: Fri, 8 May 2015 11:11:27 +0900
Subject: [PATCH] Edison x86 : Enable SD card.

Signed-off-by: eric.park <eric.park@intel.com>
---
 arch/x86/cpu/tangier/tangier.c                     | 73 +++++++++++++++++++++-
 .../x86/include/asm/arch-tangier/intel_soc_mrfld.h | 72 +++++++++++++++++++++
 boards.cfg                                         |  2 +-
 3 files changed, 143 insertions(+), 4 deletions(-)
 create mode 100644 arch/x86/include/asm/arch-tangier/intel_soc_mrfld.h

diff --git a/arch/x86/cpu/tangier/tangier.c b/arch/x86/cpu/tangier/tangier.c
index 0fbe401..f6fdf5f 100644
--- a/arch/x86/cpu/tangier/tangier.c
+++ b/arch/x86/cpu/tangier/tangier.c
@@ -15,6 +15,7 @@
 #include <asm/msr.h>
 #include <asm/arch/intel-mid.h>
 #include <asm/arch/timestamp.h>
+#include <asm/arch/intel_soc_mrfld.h>
 #include <intel_scu_ipc.h>
 #include <u-boot/md5.h>
 
@@ -34,6 +35,66 @@ int board_early_init_f(void)
 	return 0;
 }
 
+static int pmu_read_status(void)
+{
+	struct mrst_pmu_reg *const pmu_reg =
+		(struct mrst_pmu_reg *)CONFIG_SYS_TANGIER_PMU_BASE;
+	int pmu_busy_retry = 500000;
+	u32 temp;
+	union pmu_pm_status result;
+
+	do {
+		temp = readl(&pmu_reg->pm_sts);
+
+		/* extract the busy bit */
+		result.pmu_status_value = temp;
+
+		if (result.pmu_status_parts.pmu_busy == 0)
+			return 0;
+
+		udelay(1);
+	} while (--pmu_busy_retry);
+
+	return -EBUSY;
+}
+
+int power_init_board(void)
+{
+	struct mrst_pmu_reg *const pmu_reg =
+		(struct mrst_pmu_reg *)CONFIG_SYS_TANGIER_PMU_BASE;
+	u32 pm_ssc[4];
+	int i;
+
+	/* check pmu status. */
+	if (pmu_read_status()) {
+		printf("WARNING : PMU is busy.\n");
+		return -EBUSY;
+	}
+
+	/* read pmu values. */
+	for (i = 0 ; i < 4 ; i++)
+		pm_ssc[i] = readl(&pmu_reg->pm_sss[i]);
+
+	/* modify pmu values. */
+	/* enable SDIO0, sdhci for SD card*/
+	pm_ssc[0] &= ~(0x3<<(PMU_SDIO0_LSS_01*2));
+
+	/* wrtie modified pmu values. */
+	for (i = 0 ; i < 4 ; i++)
+		writel(pm_ssc[i], &pmu_reg->pm_ssc[i]);
+
+	/* update modified pmu values. */
+	writel(0x00002201, &pmu_reg->pm_cmd);
+
+	/* check pmu status. */
+	if (pmu_read_status()) {
+		printf("WARNING : PMU is busy.\n");
+		return -EBUSY;
+	}
+
+	return 0;
+}
+
 int board_early_init_r(void)
 {
 	return 0;
@@ -112,10 +173,16 @@ void panic_puts(const char *str)
 
 int board_mmc_init(bd_t * bis)
 {
-	int index = 0;
-	unsigned int base = CONFIG_SYS_EMMC_PORT_BASE + (0x40000 * index);
+	int err;
+
+	/* add sdhci for eMMC */
+	err = tangier_sdhci_init(CONFIG_SYS_EMMC_PORT_BASE, 0, 4);
+
+	if (err)
+		return err;
 
-	return tangier_sdhci_init(base, index, 4);
+	/* add sdhci for SD card */
+	return tangier_sdhci_init(CONFIG_SYS_SD_PORT_BASE, 0, 4);
 }
 
 /* ovveride get_tbclk_mhz code see tsc_timer */
diff --git a/arch/x86/include/asm/arch-tangier/intel_soc_mrfld.h b/arch/x86/include/asm/arch-tangier/intel_soc_mrfld.h
new file mode 100644
index 0000000..fc12360
--- /dev/null
+++ b/arch/x86/include/asm/arch-tangier/intel_soc_mrfld.h
@@ -0,0 +1,72 @@
+#ifndef __ASM_X86_INTEL_SOC_MRFLD_H__
+
+#define __ASM_X86_INTEL_SOC_MRFLD_H__
+
+#define PMU_PSH_LSS_00			0
+#define PMU_SDIO0_LSS_01		1
+#define PMU_EMMC0_LSS_02		2
+#define PMU_RESERVED_LSS_03		3
+#define PMU_SDIO1_LSS_04		4
+#define PMU_HSI_LSS_05			5
+#define PMU_SECURITY_LSS_06		6
+#define PMU_RESERVED_LSS_07		7
+#define PMU_USB_MPH_LSS_08		8
+#define PMU_USB3_LSS_09			9
+#define PMU_AUDIO_LSS_10		10
+#define PMU_RESERVED_LSS_11		11
+#define PMU_RESERVED_LSS_12		12
+#define PMU_RESERVED_LSS_13		13
+#define PMU_RESERVED_LSS_14		14
+#define PMU_RESERVED_LSS_15		15
+#define PMU_RESERVED_LSS_16		16
+#define PMU_SSP3_LSS_17			17
+#define PMU_SSP5_LSS_18			18
+#define PMU_SSP6_LSS_19			19
+#define PMU_I2C1_LSS_20			20
+#define PMU_I2C2_LSS_21			21
+#define PMU_I2C3_LSS_22			22
+#define PMU_I2C4_LSS_23			23
+#define PMU_I2C5_LSS_24			24
+#define PMU_GP_DMA_LSS_25		25
+#define PMU_I2C6_LSS_26			26
+#define PMU_I2C7_LSS_27			27
+#define PMU_USB_OTG_LSS_28		28
+#define PMU_RESERVED_LSS_29		29
+#define PMU_RESERVED_LSS_30		30
+#define PMU_UART0_LSS_31		31
+#define PMU_UART1_LSS_31		31
+#define PMU_UART2_LSS_31		31
+
+#define PMU_I2C8_LSS_33			33
+#define PMU_I2C9_LSS_34			34
+#define PMU_SSP4_LSS_35			35
+#define PMU_PMW_LSS_36			36
+
+#define EMMC0_LSS			PMU_EMMC0_LSS_02
+
+struct mrst_pmu_reg {
+	u32 pm_sts;             /* 0x00 */
+	u32 pm_cmd;             /* 0x04 */
+	u32 pm_ics;             /* 0x08 */
+	u32 _resv1;
+	u32 pm_wkc[2];          /* 0x10 */
+	u32 pm_wks[2];          /* 0x18 */
+	u32 pm_ssc[4];          /* 0x20 */
+	u32 pm_sss[4];          /* 0x30 */
+	u32 pm_wssc[4];         /* 0x40 */
+	u32 pm_c3c4;            /* 0x50 */
+	u32 pm_c5c6;            /* 0x54 */
+	u32 pm_msic;            /* 0x58 */
+};
+
+union pmu_pm_status {
+	struct {
+		u32 pmu_rev:8;
+		u32 pmu_busy:1;
+		u32 mode_id:4;
+		u32 Reserved:19;
+	} pmu_status_parts;
+	u32 pmu_status_value;
+};
+
+#endif
diff --git a/boards.cfg b/boards.cfg
index bf4c268..54cff07 100644
--- a/boards.cfg
+++ b/boards.cfg
@@ -1191,7 +1191,7 @@ Active  sparc       leon3          -           gaisler         -
 Active  sparc       leon3          -           gaisler         -                   gr_xc3s_1500                         -                                                                                                                                 -
 Active  sparc       leon3          -           gaisler         -                   grsim                                -                                                                                                                                 -
 Active  x86         x86            coreboot    chromebook-x86  coreboot            coreboot-x86                         coreboot:SYS_TEXT_BASE=0x01110000                                                                                                 -
-Active  x86         sivermont      tangier     intel           edison              edison                               edison:SYS_USB_OTG_BASE=0xf9100000,SYS_EMMC_PORT_BASE=0xff3fc000,SYS_TEXT_BASE=0x1101000                                          -
+Active  x86         sivermont      tangier     intel           edison              edison                               edison:SYS_USB_OTG_BASE=0xf9100000,SYS_EMMC_PORT_BASE=0xff3fc000,SYS_SD_PORT_BASE=0xff3fa000,SYS_TANGIER_PMU_BASE=0xff00b000,SYS_TEXT_BASE=0x1101000                                          -
 # The following were moved to "Orphan" in March, 2014
 Orphan  blackfin    blackfin       -           -               -                   cm-bf527                             -                                                                                                                                 Bluetechnix Tinyboards <bluetechnix@blackfin.uclinux.org>
 Orphan  blackfin    blackfin       -           -               -                   cm-bf533                             -                                                                                                                                 Bluetechnix Tinyboards <bluetechnix@blackfin.uclinux.org>
-- 
1.9.1

